/*global i18n, Chat, CurrentChat: true */
(function(e,t){var n={};n.load=function(e){var n=window.CurrentChat=new Chat(e);t("#site_chat_flash").length?n.set_loaded():r(),n.disable_chat_input(),n.clear_user_list(),n.clear_chat_lines(),n.connect(e),n.setupHandlers(),n.initializeMessageLoop()},n.disconnect=function(){CurrentChat&&(CurrentChat.disconnect(),CurrentChat.clear_user_list(),CurrentChat.clearHandlers(),setTimeout(CurrentChat.clear_chat_lines,250))},n.toggle=function(){t("#twitch_chat").is(":visible")?(t(".dropmenu").hide(),t("#chat_redisplay_holder").show(),t("#twitch_chat").fadeOut(250),n.disconnect()):(t("#chat_redisplay_holder").hide(),t("#twitch_chat").fadeIn(250),n.load(CurrentChat.channel))},n.popout=function(){n.toggle();if(!window.popout_chat_window||window.popout_chat_window.closed)window.popout_chat_window=window.open("/chat/embed?channel="+CurrentChat.channel+"&popout_chat=true","_blank","right=50,top=50,width=400,height=600,resizable=yes,scrollbars=no,toolbar=no,location=no,directories=no,status=no,menubar=no,copyhistory=no");window.popout_chat_window.focus(),i()};var r=function(){t("html").append('<div id="site_chat_flash" />');var e={show_admin:null,onsite:"true",js_interface:"CurrentChat",hostname:"www.twitch.tv",message_batching:"true"},n={allowScriptAccess:"always",allowNetworking:"all"},r={name:"site_chat_flash",style:"position: absolute;"};swfobject.embedSWF("http://www-cdn.jtvnw.net/widgets/site_chat.swf","site_chat_flash","0px","0px","9","/widgets/expressinstall.swf",e,n,r)},i=function(){window.popout_chat_window&&window.popout_chat_window.closed?n.toggle():setTimeout(i,500)};e.mixin({chat:n})})(Twitch,jQuery),function(e){var t=function(e){this.channel=e,this.api_base_url=Twitch.api.config.baseUrl,this.debug=/chat_debug=true/.test(window.location.toString()),this.devchat=!1,this.eventchat=!1,this.localchat=~window.location.search.indexOf("localchat=1"),this.flash_loaded=!1,this.show_timestamps=Twitch.storage.legacy.get("chat_show_timestamps")==="true",this.me={},this.ignored={},this.banned={},this.moderators={},this.staff={},this.admins={},this.bots={},this.turbos={},this.subscribers={},this.retries=10,this.user_to_color={},this.user_to_emote_sets={},this.appending=!1,this.queue=[],this.line_count=0,this.line_buffer=150,this.last_sender=!1,this.handlers=n,this.emoticons=[],this.emoticon_sets=[],this.default_emoticons=[],this.linkify_re=/\x02?((?:https?:\/\/|[\w\-\.\+]+@)?\x02?(?:[\w\-]+\x02?\.)+\x02?(?:com|au|org|tv|net|info|jp|uk|us|cn|fr|mobi|gov|co|ly|me|vg|eu|ca|fm|am|ws)\x02?(?:\:\d+)?\x02?(?:\/[\w\.\/@\?\&\%\#\(\)\,\-\+\=\;\:\x02?]+\x02?[\w\/@\?\&\%\#\(\)\=\;\x02?]|\x02?\w\x02?|\x02?)?\x02?)\x02?/ig,this.chat_line_div_obj=!1,this.message_queue=[]};t.prototype.initializeMessageLoop=function(){var e=this;setInterval(function(){var t=e.message_queue;e.message_queue=[];for(var n=0;n<t.length;n++){var r=t[n];try{e.onChat(r.event,r.info)}catch(i){console.log("Error handling incoming chat message of type "+r.event+" | "+i)}}},100)},t.prototype.setupHandlers=function(){var t=this;e(function(){e("#chat_loading_spinner").spin({color:"#999"}),e("#twitch_chat").append(ich["user-info"]()[0].outerHTML),Twitch.api.get("chat/"+t.channel+"/badges").done(function(e){if(!e.subscriber)return;var n=document.createElement("style");n.type="text/css";var r=".subscriber.c"+t.channel+' a { background-image: url("'+e.subscriber.image+'"); }';n.innerHTML=r,document.head.appendChild(n)}),t.populateEmoticonsSelector(),Twitch.api.get("chat/emoticons").done(function(e){var n=0,r="";e.emoticons.forEach(function(e){e.regex.match(/^\w+$/)?e.regex=new RegExp("\\b"+e.regex+"\\b","g"):e.regex=new RegExp(e.regex,"g"),e.images.forEach(function(i){n+=1,i.html=ich["chat-emoticon"]({id:n}).prop("outerHTML"),r+=t.generate_emoticon_css(i,n);var s=i.emoticon_set,o={image:i,regex:e.regex};i.emoticon_set?(t.emoticon_sets[s]===undefined&&(t.emoticon_sets[s]=[]),t.emoticon_sets[s].push(o)):t.default_emoticons.push(o)}),t.emoticons.push(e)}),r+=".emoticon { display: inline-block; }",t.add_css_style(r)}),e("#twitch_chat .js-chat-scroll").TrackpadScrollEmulator({wrapContent:!1,scrollbarHideStrategy:"rightAndBottom"}),e("#chat_text_input").on("keypress",CurrentChat.onkeypress),e("#chat_settings_dropmenu_button").popup("close_on_outside_click",e("#chat_settings_dropmenu"),{above:!0}),e("#chat_viewers_dropmenu_button").popup("click_to_close",e("#chat_viewers_dropmenu"),{above:!0,openFn:function(){CurrentChat.Chatters.subscribe(e("#chat_viewers_dropmenu"),CurrentChat.channel)}}),e("#chat_viewers_dropmenu").draggable({handle:".drag_handle",start:function(){e(this).addClass("has_moved")}}),e("#chat_viewers_dropmenu_button").on("click",function(){e("#chat_viewers_dropmenu").removeClass("has_moved")}),Twitch.user.isLoggedIn()||(e("#chat_speak, .chat_color_swatch").on("click",t.prompt_login),e("#chat_text_login").on("focus",t.prompt_login),e("#chat_text_login").on("keypress",t.prompt_login)),e("#chat_speak").on("click",function(){CurrentChat.chat_say()}),e(".js-turbo-more-colors").click(function(e){e.preventDefault(),Twitch.user(function(e){var t=e.has_turbo?"/settings/turbo":"/products/turbo?ref=more_colors_direct";window.location=t})}),Twitch.storage.legacy.get("chat_icons")==="off"?(e("#chat_lines").addClass("nobuttons"),e("#mod_icons").attr("checked",!1)):e("#mod_icons").attr("checked",!0);var n=parseInt(e(".chat_box .js-chat-scroll").css("bottom"),10),r=0;e("#emoticon-selector-toggle").on("click",function(){Twitch.tracking.mixpanel.track_with_swf("emoticon-selector-open",{channel:CurrentChat.channel});var t=e(".emoticon-selector").outerHeight(!0),i=e(".chat_box .emoticon-selector-container");e(this).toggleClass("selected"),i.outerHeight()>0?(e(".chat_box .js-chat-scroll").animate({bottom:n},200,function(){CurrentChat.scroll_chat()}),i.animate({height:r},200)):(e(".chat_box .js-chat-scroll").animate({bottom:n+t},200,function(){CurrentChat.scroll_chat()}),i.animate({height:t},200),e(".js-emoticon-selector-scroll").TrackpadScrollEmulator({wrapContent:!1,scrollbarHideStrategy:"rightAndBottom"}),e("#chat_text_input").focus())})})},t.prototype.clearHandlers=function(){e("#chat_text_input, #chat_settings_dropmenu_button, #chat_viewers_dropmenu_button, #chat_speak").off()},t.prototype.get_servers=function(){return CurrentChat.devchat?["199.9.252.26"]:CurrentChat.eventchat?["199.9.252.26","199.9.251.213"]:CurrentChat.localchat?["127.0.0.1"]:["199.9.253.199","199.9.250.229","199.9.253.210","199.9.250.239"]},t.prototype.get_darklaunch=function(){return Math.random()<SiteOptions.chat_darklaunch_pct},t.prototype.generate_emoticon_css=function(e,t){var n="";return e.height>18&&(n="margin: -"+(e.height-18)/2+"px 0px"),".emo-"+t+" {"+'background-image: url("'+e.url+'");'+"height: "+e.height+"px;"+"width: "+e.width+"px;"+n+"}"},t.prototype.add_css_style=function(e){var t=document.createElement("style");t.type="text/css";try{t.innerHTML=e}catch(n){t.styleSheet.cssText=e}document.getElementsByTagName("head")[0].appendChild(t)},t.prototype.clearEmoticonsContainer=function(){e("#emoticon-grid ul.emoticon-list").empty()},t.prototype.toggleNonSubscribeMessage=function(t){e(".emoticon-selector").toggleClass("not-subscribed",t),e(".emoticon-lock").toggle(t),e("#non-subscriber-message").toggle(t)},t.prototype.initializeEmoticons=function(t,n,r){var i=function(e,t){if(e.attr("disabled"))return;var n,r=e.val(),i=r[r.length-1];i&&i!==" "?n=" "+t:n=t,e.val(e.val()+n)},s=function(t,n){e("#non-subscriber-message .subscribe-button").attr("href",t+"?ref=emoticon_selector"),e("#non-subscriber-message .subscribe-price").text(n)};if(e("#chat").length&&t&&t.length>0){n||s(r.link,r.price);for(var o=0;o<t.length;o++){var u=t[o];if(u.state!="active")continue;var a=e('<li><div class="emoticon-lock"></div><img class="emoticon-img" src="'+u.url+'" title="'+u.regex+'" /></li>');e("#emoticon-grid ul.emoticon-list").append(a),e("img.emoticon-img",a).click(function(t){return function(){Twitch.tracking.mixpanel.track_with_swf("emoticon-selector-click",{channel:CurrentChat.channel}),n?(chatInput=e("#chat_text_input"),i(chatInput,t.regex)):Twitch.user.isLoggedIn()||e.login({mpSourceAction:"chat-emoticon"})}}(u))}CurrentChat.toggleNonSubscribeMessage(!n),e(".emoticon-img").tipsy({gravity:"s"}),e("#emoticon-selector-toggle").toggle(!0)}},t.prototype.populateEmoticonsSelector=function(){var e=CurrentChat.channel,t=function(){Twitch.api.get("/api/channels/"+CurrentChat.channel+"/product").then(function(t){var n=t.emoticons;CurrentChat.channel===e&&CurrentChat.initializeEmoticons(n,!1,{link:t.product_url,price:t.price})})};this.clearEmoticonsContainer(),Twitch.user.isLoggedIn()?Twitch.api.get("/api/users/:login/tickets?channel="+CurrentChat.channel).then(function(n){if(n.tickets[0]!==undefined){var r=n.tickets[0].product.emoticons;CurrentChat.channel===e&&CurrentChat.initializeEmoticons(r,!0)}else t()},t):t()},t.prototype.get_ports=function(){return this.localchat?[6667]:[80,443]},t.prototype.update_user_image=function(t,n){var r=e("#speak_box img").first();r&&(t&&r.attr("src",t),n&&r.attr("alt",n))},t.prototype.disable_chat_input=function(t){e("#chat_text_input").attr("disabled",!t),e("#chat_loading_spinner").show();var n=e("#chat_lines, #speak");n.toggleClass("fademe",!t),t||e("#emoticon-selector-toggle").toggle(!1)},t.prototype.enable_chat_input=function(){this.disable_chat_input(!0)},t.prototype.prompt_login=function(){e.login({mpSourceAction:"chat"})},t.prototype.onkeypress=function(e){var t=e||window.event,n=t.charCode||t.keyCode;if(n!==13)return!0;if(!t.shiftKey&&!t.shiftLeft)return e.stopPropagation&&e.stopPropagation(),CurrentChat.chat_say(),!1},t.prototype.logger=function(){return},t.prototype.set_loaded=function(){this.flash_loaded=!0},t.prototype.onChat=function(e,t){e!=="debug"&&e!=="special_user"&&this.logger("onChat",e,t);var n=this.handlers[e];n&&n.call(this,t)},t.prototype.set_currently_scrolling=function(e){e=this.chat_lines_div(),e.scrollTop+e.offsetHeight<e.scrollHeight-10?this.currently_scrolling=!1:this.currently_scrolling=!0},t.prototype.chat_lines_div=function(){return this.chat_line_div_obj?this.chat_line_div_obj:(this.chat_line_div_obj=e("#chat_lines")[0],this.chat_line_div_obj)},t.prototype.scroll_chat=function(){this.currently_scrolling&&(this.chat_lines_div().scrollTop=this.chat_lines_div().scrollHeight)},t.prototype.chat_onkeypress=function(e){e||(e=window.event);if(e.keyCode==="13")return this.chat_say(),!1},t.prototype.admin_message=function(e,t){if(/commercial break/.test(e))try{start_time_since_commercial()}catch(n){}this.last_sender="jtv";var r={message:e,showIndicator:t};this.insert_with_lock("#chat_line_list",ich["chat-line-admin"](r)[0].outerHTML)},t.prototype.escape_json=function(e){return e.replace(/\{/gi,"&#123;").replace(/\}/gi,"&#125;")},t.prototype.emoticonize=function(e,t){var n=this,r=n.user_to_emote_sets[t]||[];return r.forEach(function(t){if(n.emoticon_sets[t]===undefined)return;n.emoticon_sets[t].forEach(function(t){e.match(t.regex)&&(e=e.replace(t.regex,t.image.html))})}),n.default_emoticons.forEach(function(t){e.match(t.regex)&&(e=e.replace(t.regex,t.image.html))}),e},t.prototype.linkify=function(e,t,n){n||(n={});var r=n.target_type==="none"?"":'target="_blank"',i="";return!CurrentChat.channel_hide_chat_links||t===CurrentChat.channel||t==="jtv"||t in CurrentChat.moderators?(i=e.replace(this.linkify_re,function(e){if(/\x02/.test(e))return e;if(e.indexOf("@")>-1&&(e.indexOf("/")===-1||e.indexOf("@")<e.indexOf("/")))return'<a href="mailto:'+e+'">'+e.breaking(23)+"</a>";var n=e;return t==="jtv"&&(n=e.replace(/\?.*/g,"")),'<a href="'+e+'" '+r+">"+n.breaking(23)+"</a>"}),i=i.replace(/.{0,3}(\S{23}\S+)/g,function(e){return/<|>/.test(e)?e:e.breaking(23)})):i=e.replace(this.linkify_re,"&lt;deleted link&gt;"),i.replace(/<a href=\"(?!(?:https?:\/\/|mailto:))/g,'<a href="http://')},t.prototype.insert_chat_line=function(e){if(this.restarting&&!this.history_ended)return;if(this.ignored[e.sender])return;if(e.sender==="jtv"||e.sender==="twitchnotify"){this.last_sender=e.sender,this.admin_message(this.format_message(e),e.sender==="twitchnotify");return}if(!e.is_action&&this.last_sender&&this.last_sender===e.sender&&this.last_sender!=="jtv"){var t='<p class="chat_line" style="display:block;">&raquo; '+this.format_message(e)+"</p>";this.insert_with_lock("#chat_line_list li:last",t)}else{this.last_sender=e.sender;var n=!!(Twitch.user.login()===CurrentChat.channel||CurrentChat.userData&&(CurrentChat.userData.is_staff||CurrentChat.userData.is_admin)||this.staff[Twitch.user.login()]||this.admins[Twitch.user.login()]||this.moderators[Twitch.user.login()]),r=e.is_action?"chat-line-action":"chat-line",i=!1,s=unescape(e.nickname);s.indexOf("ign-")===0&&(i=!0,s=s.substr("ign-".length));var o="chat-line-"+Math.round(Math.random()*1e9),u={id:o,showModButtons:n&&e.sender!=="jtv"&&e.sender!==Twitch.user.login(),timestamp:this.show_timestamps||!this.history_ended?e.timestamp:"",sender:e.sender,displayname:s,color:e.color},a="",f="";e.tagtype&&(f='<span class="tag %tagtype" title="%tagname">%tagname</span>&nbsp;',a=f.replace(/\%tagtype/g,e.tagtype).replace(/\%tagname/g,e.tagname)),e.turbo&&(f='<span class="tag %tagtype" title="%tagname">',f+='<a href="/products/turbo?ref=chat_badge" target="_blank">%tagname</a>',f+="</span> ",a+=f.replace(/\%tagtype/g,"turbo").replace(/\%tagname/g,"Turbo")),e.subscriber&&(f='<span class="tag %tagtype c%tagchannel" title="%tagname">',f+='<a href="/'+this.channel+'/subscribe?ref=in_chat_subscriber_link" target="_blank">%tagname</a>',f+="</span> ",a+=f.replace(/\%tagtype/g,"subscriber").replace(/\%tagname/g,"Subscriber").replace(/\%tagchannel/g,this.channel)),i&&(f='<span class="tag %tagtype" title="%tagname">%tagname</span>&nbsp;',a+=f.replace(/\%tagtype/g,"ign").replace(/\%tagname/g,"My IGN"));var l=ich[r](u)[0].outerHTML;l=l.replace(/\@tag/g,a),l=l.replace(/\@message/g,this.format_message(e)),!e.is_action&&e.sender!=="jtv"?this.insert_with_lock("#chat_line_list",l,e,o):this.insert_with_lock("#chat_line_list",l)}},t.prototype.format_message=function(e){if(e.sender==="jtv")return this.linkify(e.message,e.sender);var t=escape_html(e.message),n=this.linkify(t,e.sender);return n===t&&(n=this.emoticonize(n,e.sender)),n},t.prototype.insert_with_lock=function(e,t,n,r){this.queue.push({el:e,line:t,info:n,linkid:r});if(!this.appending){this.appending=!0;var i=this;setTimeout(function(){i.insert_with_lock_in()},50)}},t.prototype.insert_with_lock_in=function(){var t=this.set_currently_scrolling;this.set_currently_scrolling=function(){};var n,r=!1,i="",s=[];while(this.queue.length>0)n=this.queue.shift(),n.linkid&&s.push({info:n.info,linkid:n.linkid}),n.el==="#chat_line_list"&&(this.line_count+=1),r&&r!==n.el&&(e(r).append(i),i=""),r=n.el,i+=n.line;r&&e(r).append(i);for(var o=0;o<s.length;o++)n=s[o],this.setup_viewer_handlers(n.info,n.linkid);this.line_count>this.line_buffer&&(e("#chat_line_list li:lt("+(this.line_count-this.line_buffer)+")").remove(),this.line_count=this.line_buffer),this.history_ended&&this.scroll_chat();var u=this;setTimeout(function(){u.history_ended&&u.scroll_chat(),u.set_currently_scrolling=t,u.appending=!1},1)},t.prototype.format_chat_info=function(e,t){var n=this.nickname_info(e.sender);e.nickname=n.name,e.timestamp=(e.timestamp?new Date(e.timestamp):new Date).to_chat_timestamp(),e.is_action=e.is_action||!1;var r;if(!t&&/^externaluser\-(facebook|twitter)/i.test(e.sender))try{r=JSON.parse(e.message)}catch(i){}return r&&r.message&&(e.message=r.message,e.image_url=r.image_url,e.is_action=r.is_action||e.is_action,e.login=r.login,e.facebook_id=r.facebook_id,e.name=r.name,e.profile_url=r.profile_url),e.color=this.get_color_for_user(e.nickname),e.profile_url="http://www.justin.tv/"+e.nickname+"/videos",this.staff[e.sender]?(e.tagtype="staff",e.tagname=i18n("Staff"),e.explanation="Staff at Justin.tv"):this.bots[e.sender]?(e.tagtype="bot",e.tagname=i18n("Bot"),e.explanation="A Chat Bot"):this.admins[e.sender]?(e.tagtype="admin",e.tagname=i18n("Admin"),e.explanation="Volunteer Admin"):e.sender===this.channel?(e.broadcaster=!0,e.tagtype="broadcaster",e.tagname=i18n("Broadcaster"),e.explanation="Justin.tv Broadcaster"):this.moderators[e.sender]?(e.tagtype="mod",e.tagname=i18n("Mod"),e.explanation="Channel Moderator"):(e.tagtype=null,e.tagname=null,e.explanation=null),e.turbo=this.turbos[e.sender],e.subscriber=this.subscribers[e.sender],e},t.prototype.nickname_info=function(e){if(!e)return{chat_type:"jtv",name:"me"};var t=e.replace(/^(Externaluser|chat\_from\_externaluser)\-/i,"");return{chat_type:"jtv",name:t||"me"}},t.prototype.update_user=function(e){this.user_item(e).length&&(this.remove_user(e),this.add_user(e))},t.prototype.add_user=function(e){},t.prototype.is_op=function(){return[Twitch.user.login(),this.sender()].filter(function(e){return e===CurrentChat.channel||!!CurrentChat.staff[e]||!!CurrentChat.admins[e]}).length>0},t.prototype.is_mod=function(){return CurrentChat.userData&&CurrentChat.userData.is_staff||[Twitch.user.login(),this.sender()].filter(function(e){return!!(e===CurrentChat.channel||CurrentChat.staff[e]||CurrentChat.admins[e]||CurrentChat.moderators[e])}).length>0},t.prototype.setup_viewer_handlers=function(t,n,r){e("#"+n).click(function(n){return n.stopPropagation(),CurrentChat.setup_chat_popup(t),e("#chat_viewers_dropmenu").fadeTo(0,0),!1})},t.prototype.setup_chat_popup=function(t){var n=t.sender,r={ignore:"unignore",unignore:"ignore",ban:"unban",unban:"ban",voice:"unvoice",unvoice:"voice",timeout:null,op:"deop",deop:"op",follow:"unfollow",unfollow:"follow"};_.each(["follow","unfollow","ignore","unignore","ban","unban","voice","unvoice","timeout","op","deop","pm"],function(t){e("#chat_menu_"+t).unbind("click").click(function(){CurrentChat[t](n),e("#chat_menu_"+t).hide();var i=r[t];i&&e("#chat_menu_"+i).show(),CurrentChat.close_chat_popup()})}),[["user_link_actions",!0],["chat_user_pic",!0],["chat_user_channel_link",!1],["chat_user_pic",!0],["chat_menu_op_tools",this.is_mod()],["chat_menu_owner_tools",this.is_op()],["chat_menu_pm",this.admins[Twitch.user.login()||null]||this.staff[Twitch.user.login()||null]],["chat_menu_ignore",!this.ignored[n]],["chat_menu_unignore",!!this.ignored[n]],["chat_menu_timeout",!this.banned[n]],["chat_menu_ban",!this.banned[n]],["chat_menu_unban",!!this.banned[n]],["chat_menu_voice",!this.moderators[n]],["chat_menu_op",!this.moderators[n]],["chat_menu_deop",!!this.moderators[n]],["chat_menu_follow",!1],["chat_menu_unfollow",!1]].forEach(function(e){document.getElementById(e[0]).style.display=e[1]?"":"none"});var i=n.replace(/[@\+]/,"");e("#chat_menu_login").html(escape_html(unescape(this.real_username(t.nickname)))),e("#chat_user_channel_link").attr("href","/"+i),e("#chat_user_videos_link").attr("href","/"+i+"/profile"),e("#chat_user_message_link").attr("href","/message/compose?to="+i),e("#user_info").show(),e.get("/live/chat_menu_update?login="+i).done(function(t){t.is_broadcaster&&e("#chat_user_channel_link").show(),t.following?e("#chat_menu_unfollow").show():e("#chat_menu_follow").show()})},t.prototype.close_chat_popup=function(){e("#user_info").hide(),e("#chat_viewers_dropmenu").fadeTo(0,1),e("#chat_viewers_dropmenu").hasClass("has_moved")||e("#chat_viewers_dropmenu").hide()},t.prototype.remove_user=function(e){if(this.user_item(e).length){this.remove_viewer_handlers&&this.remove_viewer_handlers(e);var t=this.user_item(e).parent();this.user_item(e).remove(),t.children().length===0&&t.parent().hide()}},t.prototype.user_item_id=function(e){return"chat_user_"+e.replace(/[@+%]/,"")},t.prototype.user_item=function(t){return e("#"+this.user_item_id(t))},t.prototype.is_anonymous=function(e){return!e||/^justinfan\d+/.test(e)},t.prototype.getIrcSystem=function(){var t=e("#site_chat_flash");return t?t[0]:null},function(){t.prototype.connect=function(t){e(".chat_box").first().show();var n=this,r=new RSVP.Promise(function(e,n){Twitch.api.get("/api/channels/"+t+"/chat_properties").done(function(t){e(t)})}),i=function(){return new RSVP.Promise(function(e,t){var r=function(){n.ircSystem=n.getIrcSystem(),n.ircSystem&&n.flash_loaded&&n.ircSystem.connect?e(n.ircSystem):setTimeout(r,250)};r()})},s=function(){return new RSVP.Promise(function(e,t){Twitch.user.isLoggedIn()||e(),Twitch.user(function(t){n.userData=t,e(t)})})};r.then(function(e){return n.channel_hide_chat_links=e.hide_chat_links,n.require_verified_account=e.require_verified_account,n.game=e.game,n.devchat=e.devchat,n.eventchat=e.eventchat,RSVP.all([s(),i()])}).then(function(){n.save_room(t),n.join_on_connect=t,n.debug&&n.admin_message("DEBUG: Connecting to "+t),Twitch.user.isLoggedIn()?n.ircSystem.connect(t,Twitch.user.login(),"oauth:"+n.userData.chat_oauth_token):n.ircSystem.connect(t)})},t.prototype.disconnect=function(){CurrentChat.ircSystem.disconnect()},t.prototype.reconnect=function(t){this.retries>1?this.admin_message(s_(i18n("Trying %s more times to reconnect..."),this.retries)):this.retries===1&&this.admin_message(i18n("Trying 1 more time to reconnect..."));var n=this.ircSystem.cloneNode(!0);this.ircSystem.parentNode.replaceChild(n,this.ircSystem),this.ircSystem=n,this.me.is_loaded=!1;if(this.retries>0){this.retries--;var r=this.room;setTimeout(function(){CurrentChat.connect(r)},1e3)}else this.admin_message(i18n("It's not working")+" :-("),e("#speak_input").hide(),e("#chat_menu").hide(),e("#show_chat_options").hide(),e("#chat_help_btn").hide()},t.prototype.setup_chat_settings_menu=function(){e("#chat_color_container").length&&(e("#chat_color_container").show(),e("#chat_colors").hide()),e("#chat_clear").show(),this.is_mod()?e("#chat_section_moderation").show():e("#chat_section_moderation").hide()},t.prototype.save_room=function(e){e=this.stripChannel(e),this.room=e,this.channel=e.split("-")[0]},t.prototype.formatChannel=function(e){return e.substr(0,1)!=="#"&&(e="#"+e),e},t.prototype.stripChannel=function(e){return e.replace("#","")},t.prototype.default_colors=[["Red","#FF0000"],["Blue","#0000FF"],["Green","#00FF00"],["FireBrick","#B22222"],["Coral","#FF7F50"],["YellowGreen","#9ACD32"],["OrangeRed","#FF4500"],["SeaGreen","#2E8B57"],["GoldenRod","#DAA520"],["Chocolate","#D2691E"],["CadetBlue","#5F9EA0"],["DodgerBlue","#1E90FF"],["HotPink","#FF69B4"],["BlueViolet","#8A2BE2"],["SpringGreen","#00FF7F"]],t.prototype.get_color_for_user=function(e){var t;e||(e="me");if(this.user_to_color[e])t=this.user_to_color[e];else{var n=e.charCodeAt(0)+e.charCodeAt(e.length-1);t=this.default_colors[n%this.default_colors.length][1]}return t},t.prototype.set_color_for_user=function(t,n){if(t===Twitch.user.login()){var r=e(".chat_color_swatch");r.filter(".current").removeClass("current"),r.filter("."+n.toUpperCase().slice(1)).addClass("current")}this.user_to_color[t]=n},t.prototype.sender=function(){return(Twitch.user.login()||"").toLowerCase()},t.prototype.chat_say=function(t){var n=t||e("#chat_text_input")[0],r=n.value;/^\/commercial(?=\s|$)/.test(r)&&Twitch.tracking.mixpanel.track_with_swf("commercial",{channel:CurrentChat.channel,trigger:"chat"}),r.replace(/\s/gi,"")!==""&&(this.say(r.replace("\n"," ")),n.value=""),this.scroll_chat(),Twitch.tracking.mixpanel.track_with_swf("chat",{channel:CurrentChat.channel,account_verification_required:CurrentChat.require_verified_account,user_account_is_verified:CurrentChat.userData.account_verified,game:CurrentChat.game})},t.prototype.show_chat_colors=function(){e("#chat_colors").toggle(0)},t.prototype.hide_chat_colors=function(){e("#chat_colors").hide()},t.prototype.onClose=function(){this.logger("onClose"),this.admin_message(i18n("Sorry, you were disconnected.")),setTimeout(CurrentChat.reconnect(),1e3)}}(),function(){t.prototype.set_mod_icons_visible=function(t){t?(e("#chat_lines").removeClass("nobuttons"),Twitch.storage.legacy.set("chat_icons","on",31536e3)):(e("#chat_lines").addClass("nobuttons"),Twitch.storage.legacy.set("chat_icons","off",31536e3))},t.prototype.display_icons_from_cookie=function(){Twitch.storage.legacy.get("chat_icons")==="off"?(e("#chat_lines").addClass("nobuttons"),e("#mod_icons").prop("checked",!1)):(e("#chat_lines").removeClass("nobuttons"),e("#mod_icons").prop("checked",!0))},t.prototype.clear_user_list=function(){e("#viewer_list ul.js-viewer-list").empty()},t.prototype.clear_chat_lines=function(){e("#chat_line_list").empty(),this.line_count=0},t.prototype.toggle_show_timestamps=function(){this.show_timestamps=!this.show_timestamps,Twitch.storage.legacy.set("chat_show_timestamps",this.show_timestamps,604800)},t.prototype.send_command=function(e){this.logger("Sending command"),this.ircSystem.send_command(e)},t.prototype.follow=function(e){Twitch.user.isLoggedIn()?Twitch.api.put("users/:login/follows/channels/"+e):this.prompt_login()},t.prototype.unfollow=function(e){Twitch.user.isLoggedIn()?Twitch.api.del("users/:login/follows/channels/"+e):this.prompt_login()},t.prototype.join_room=function(e){this.save_room(e),this.part_room(),this.clear_user_list(),this.connect(e)},t.prototype.real_username=function(e){return e||(e="me"),e.charAt(0)==="@"||e.charAt(0)==="+"?e.substring(1):e.split(" ")[0]},t.prototype.help=function(){show_info_popup(i18n("Chat Commands"),'<iframe src="/chat_commands.html" width="100%" height="600" frameBorder="0" ></iframe>',null,"double")}}(),function(){t.prototype.say=function(e,t){var n,r;this.logger("Sending public message");if(window.SitePageType==="channel"&&/^\/help/.test(e))this.help();else if(e.substr(0,1)!=="/")this.insert_chat_line(this.format_chat_info(_.extend({sender:this.sender(),message:this.escape_json(e),is_action:!1},t),!0)),this.ircSystem.send_channel_message(e);else if(e.match(/^\/me\s+/)){var i=e.substr(4);this.insert_chat_line(this.format_chat_info(_.extend({sender:this.sender(),message:this.escape_json(i),is_action:!0},t),!0)),this.ircSystem.send_channel_action(i)}else(n=e.match(/^\/ignore (\w+)/))?this.ignore(n[1]):(r=e.match(/^\/unignore (\w+)/))?this.unignore(r[1]):this.ircSystem.send_channel_message(e);gaTrackEvent("Chat","Message","gaming",e.length)},t.prototype.timeout=function(t,n){this.say("/timeout "+t);var r=e(".chat_from_"+t.replace(/%/g,"_")+" .mod_button.timeout img");r.attr("src","/images/xarth/g/g18_clock-00000020.png")},t.prototype.slow_mode_on=function(){this.say("/slow")},t.prototype.slow_mode_off=function(){this.say("/slowoff")},t.prototype.ignore=function(e){var t=this;Twitch.user.isLoggedIn()?Twitch.api.put("users/:login/blocks/"+e).done(function(){t.ignored[e]=!0,Twitch.notify.success(i18n("User successfully ignored"))}).fail(function(e){try{Twitch.notify.error(JSON.parse(e.responseText).message)}catch(t){Twitch.notify.error(i18n("There was a problem ignoring that user"))}}):this.prompt_login()},t.prototype.unignore=function(e){var t=this;Twitch.user.isLoggedIn()?Twitch.api.del("users/:login/blocks/"+e).done(function(){delete t.ignored[e],Twitch.notify.success(i18n("User successfully unignored"))}).fail(function(e){try{Twitch.notify.error(JSON.parse(e.responseText).message)}catch(t){Twitch.notify.error(i18n("There was a problem unignoring that user"))}}):this.prompt_login()},t.prototype.clear=function(){this.say("/clear")},t.prototype.action=function(e,t){this.say("/me "+e)},t.prototype.voice=function(e){this.send_command("MODE #"+this.channel+" +v "+e)},t.prototype.unvoice=function(e){this.send_command("MODE #"+this.channel+" -v "+e)},t.prototype.ban=function(t){this.say("/ban "+t),this.banned[t]=!0,e(".chat_from_"+t+" .mod_button.ban").hide(),e(".chat_from_"+t+" .mod_button.unban").show()},t.prototype.unban=function(t){this.say("/unban "+t),delete this.banned[t],e(".chat_from_"+t+" .mod_button.ban").show(),e(".chat_from_"+t+" .mod_button.unban").hide()},t.prototype.op=function(e){this.say("/mod "+e)},t.prototype.deop=function(e){this.say("/unmod "+e)},t.prototype.rooms=function(e){this.send_command("JTVROOMS "+this.channel)},t.prototype.part_room=function(){this.send_command("PART "+this.room)},t.prototype.user_color=function(t){this.say("/color "+t),this.set_color_for_user(Twitch.user.login(),t),e("#chat_color_container").length&&this.hide_chat_colors()}}(),window.Chat=t;var n={error_on_join:function(e){this.admin_message(e.message)},user_color:function(e){this.set_color_for_user(e.user,e.color)},emote_sets:function(e){this.user_to_emote_sets[e.user]=JSON.parse(e.sets)},error:function(e){this.reconnect()},connected:function(t){this.join_on_connect&&this.join(this.join_on_connect),this.join_on_connect=null,this.clear_chat_lines(),e("#chat_text_input").removeAttr("disabled"),this.debug&&this.ircSystem.debugOn()},who_reply:function(e){},no_such_nick:function(t){e("#chat_text_input").removeAttr("disabled")},you_are_banned:function(e){this.admin_message(i18n("Sorry, you are banned from this chat room."))},debug:function(e){this.debug&&this.admin_message("DEBUG: "+e.message)},clear_chat:function(t){this.last_sender=!1;if(t.target==="all")this.clear_chat_lines(),this.admin_message(i18n("Chat was cleared by a moderator"));else if(t.target==="user"){var n=this.real_username(t.user),r=e("#chat_line_list .chat_from_"+t.user.replace(/%/g,"_").replace(/[<>,]/g,"")+" .chat_line");r.each(function(){var t=e(this);if(t.html()){var n=ich["chat-deleted-message"]({originalMessage:t.html(),deletedPrompt:i18n("message deleted")});t.html(n)}})}},batch:function(e){this.message_queue.push.apply(this.message_queue,e)},channel_message:function(e){this.insert_chat_line(this.format_chat_info(e))},private_message:function(e){this.insert_chat_line(this.format_chat_info(e))},dmcakill:function(e){top.location.replace("http://www.twitch.tv/"+CurrentChat.channel+"/dmca_violation")},toskill:function(e){top.location.replace("http://www.twitch.tv/"+CurrentChat.channel+"/tos_violation")},shutdown:function(e){this.admin_message(i18n("This chat server is restarting for maintainance. You should reconnect in a few seconds.")),this.disable_chat_input(),this.restarting=!0},room_slow_mode_on:function(t){this.admin_message(i18n("This room is now in slow mode. Viewers have a limit on their lines per minute.")),e("#slow_mode").attr("checked",!0)},room_slow_mode_off:function(t){this.admin_message(i18n("This room is no longer in slow mode. Everyone can chat freely.")),e("#slow_mode").attr("checked",!1)},reconnect_attempt:function(t){if(this.reconnect_timer)return;this.admin_message(s_(i18n("Sorry, we were unable to connect to chat. Reconnecting in %s seconds."),"<span class='js-chat_countdown'>"+t.seconds+"</span>")),this.reconnect_timer=t.seconds;var n=this,r=setInterval(function(){var t=e(".js-chat_countdown").last();n.reconnect_timer>0&&(n.reconnect_timer--,t.html(n.reconnect_timer)),n.reconnect_timer===0&&(e("#chat_loading_spinner").show(),clearInterval(r))},1e3);e("#chat_loading_spinner").hide()},user_names:function(e){for(var t=0;t<e.names.length;t++)this.add_user(e.names[t].strip())},user_names_end:function(e){this.admin_message(i18n("Welcome to the chat room!"))},join:function(e){this.add_user(e.nickname)},part:function(e){this.remove_user(e.nickname)},history_end:function(t){this.enable_chat_input(),e("#chat_loading_spinner").hide(),CurrentChat.history_ended=!0,CurrentChat.restarting&&CurrentChat.admin_message(i18n("And we're back.")),CurrentChat.restarting=!1,CurrentChat.currently_scrolling=!0,CurrentChat.scroll_chat(),CurrentChat.setup_chat_settings_menu()},emergency:function(e){var t=e.message.replace(/\/(\w+)/,function(e){return'<a href="'+e+'" target="blank">'+e+"</a>"});this.notify(t,"emergency")},user_oped:function(e){if(e.target===Twitch.user.login()||e.target===this.sender())this.ircSystem.who(this.formatChannel(this.channel)),this.display_icons_from_cookie();this.moderators||(this.moderators={}),this.moderators[this.real_username(e.target)]=!0,this.update_user("@"+this.real_username(e.target))},user_deoped:function(t){if(t.target===Twitch.user.login()||t.target===this.sender())e("#contextual_unmoderation_link").hide(),e("#chat_mod").hide();this.moderators&&delete this.moderators[this.real_username(t.target)],this.update_user(this.real_username(t.target))},user_banned:function(e){e.banned===this.usershosts[Twitch.user.login()]&&(this.admin_message(i18n("You were banned from this channel. If you think that you were banned unfairly, please send an email to info@justin.tv with the transcript leading up to this message.")),this.me.banned=!0),e.from_me&&this.admin_message(s_(i18n("Successfully banned %s"),e.banned))},user_unbanned:function(e){e.from_me&&this.admin_message(s_(i18n("Successfully removed ban from %s"),e.unbanned))},user_voiced:function(e){e.from_user!=="jtv"&&this.admin_message(s_(i18n("Voice granted to %s by %s"),e.target,e.from_user)),this.update_user("+"+this.real_username(e.target))},user_unvoiced:function(e){e.from_user!=="jtv"&&this.admin_message(s_(i18n("Voice removed from %s by %s"
),e.target,e.from_user)),this.update_user(this.real_username(e.target))},special_user:function(e){var t={admin:"admins",bot:"bots",moderator:"moderators",turbo:"turbos",subscriber:"subscribers",staff:"staff"}[e.kind];t&&(this[t][e.user]=!0),this.update_user(e.user)},welcome:function(e){}},r={UPDATE_TIMEOUT:5e3,GROWTH_RATE:.2,MAX_INTERVAL:50,initialLoad:!0,initialRender:!0,subscribe:function(e,t){this.element=e,this.channel=t,this.updateNum=0,this.update()},update:function(){var t=this,n;if(!t.element.is(":visible"))return;t.initialLoad&&(t.element.spin(),t.initialLoad=!1),e.ajax({url:"https://tmi.twitch.tv/group/user/"+t.channel+"/chatters?update_num="+t.updateNum+"&callback=?",cache:!1,dataType:"jsonp",timeoutLength:6e3}).done(function(e){t.render(e)}).always(function(){t.element.spin(!1),t.updateNum<t.MAX_INTERVAL&&t.updateNum++,n=Math.floor(t.UPDATE_TIMEOUT*Math.pow(1+t.GROWTH_RATE,t.updateNum)),t.timeout&&clearTimeout(t.timeout),t.timeout=setTimeout(t.update.bind(t),n)})},render:function(t){var n=this;if(t.status!==200)return;n.initialRender&&(n.element.find(".js-chat-scroll").TrackpadScrollEmulator({wrapContent:!1,scrollbarHideStrategy:"rightAndBottom"}),n.initialRender=!1),["staff","admins","moderators","viewers"].forEach(function(e){var r=n.element.find(".js-"+e),i=r.find(".js-viewer-list");i.empty();var s=[];t.data.chatters[e].forEach(function(e){s.push('<a class="viewer">'+e+"</a>")}),i.append(s.join("<br />")),i.children().length?r.show():r.hide()}),n.element.on("click",".viewer",function(t){t.preventDefault();var n=e(this).text(),r=CurrentChat.user_item_id(n),i=CurrentChat.format_chat_info({sender:n});CurrentChat.setup_chat_popup(i),e("#chat_viewers_dropmenu").fadeTo(0,.7)})}};t.prototype.Chatters=r,e(function(){if(typeof CurrentChat!="undefined"){var t=e("#twitch_chat .tag");t&&typeof t.tipsy=="function"&&t.tipsy({gravity:"sw",live:!0});if(Twitch.user.login()){var n={};Twitch.api.get("users/:login/blocks",{limit:500}).done(function(e){e.blocks.forEach(function(e){n[e.user.name]=!0}),CurrentChat.ignored=n})}e("body").on("click",".mod_button.timeout",function(){CurrentChat.timeout(e(this).parents(".line").data("sender"))}).on("click",".mod_button.ban",function(){CurrentChat.ban(e(this).parents(".line").data("sender"))}).on("click",".mod_button.unban",function(){CurrentChat.unban(e(this).parents(".line").data("sender"))}).on("click",".js-new-tab",function(t){t.preventDefault(),open(e(this).attr("href"),"_blank")}).on("click",".js-deleted-message",function(t){t.preventDefault(),e(this).hide(),e(this).next(".js-revealed-message").show()})}})}(jQuery);